{% extends "layout.html" %}
{% block header_css %}
<head>
    <title>Layout Selector</title>
    {{ super() }}
</head>
{% endblock %}
{% block body %}
<div class="row">
  <!-- Sidebar -->
  <div class="col-md-1 EDIT_ONLY" style="position:fixed">
    {% for element in elements %}
      <div class="element" style="border:1px;border-style:outset;border-radius:5px" data-name="{{ element.name }}" data-filepath="{{ element.filePath }}">
        {% if element.image %}
          <img src="{{ element.image }}" style="width:70px;height:70px">
        {% else %}
          <img src="../static/images/Manda-Pie-Back-To-School-Books.ico" alt="Mountain View" style="width:70px;height:70px">
        {% endif %}
        <br>
        &nbsp;&nbsp;{{ element.name }}
      </div>
      <br>
    {% endfor %}
  </div>
  <!-- Question List -->
  <div class="col-md-9 col-md-offset-2" id="questionList">
    <div class="row">
      <div id="elementWell" class="elementWell EDIT_ONLY" style="border:1px;border-style:dashed;border-radius:5px;height:300px" align="center">
        <br><br>To begin, drag elements onto the screen.
      </div>
    </div>
    <br>
    <div class="row">
        <input type="button" value="Preview" class="btn btn-success btn-lg pull-right PREVIEW_ONLY" id="preview">
        <p class="pull-right PREVIEW_ONLY">&nbsp;&nbsp;</p>
        <input type="button" value="Delete All" id="delete-all" class="btn btn-danger btn-lg pull-right EDIT_ONLY">
        <p class="pull-right PREVIEW_ONLY">&nbsp;&nbsp;</p>
        <input type="button" value="Submit" id="submit" class="btn btn-default btn-lg pull-right TAKE_ONLY PREVIEW_ONLY" style="display:None">
    </div>
  </div>
</div>
{% endblock %}
{% block js_bottom %}
{{ super() }}
<link rel="stylesheet" href="{{url_for('static', filename='jquery-ui-1.10.3.custom/development-bundle/themes/smoothness/jquery-ui.css')}}" />
<script src="{{url_for('static', filename='jquery-ui-1.10.3.custom/js/jquery-ui-1.10.3.custom.min.js')}}"></script>
<script type="text/javascript">
  var radioGroupCount = 0;

  function createElement(elementWell, elementToCreate){
      elementWell.before("<div class='elementTarget'></div>");
      var target = elementWell.parent().find(".elementTarget").first();
      target.load(elementToCreate.data('filepath'));
      target.removeClass('elementTarget');
      return target;
  }
  function makeDroppable(element){
    element.droppable({
      drop: function(event, ui){
        var elementWell = $(this);
        var element = ui.draggable;
        var newElement = createElement(elementWell, element);
        makeDroppable(newElement);     
      }
    })
  }
  function getVideoURL(original){
    // will likely need to add more url handlers later, 
    // for now we support youtube urls
    if(original.indexOf("<iframe") >= 0){
      var src = original.substring(original.indexOf('src="')+5);
      src = src.substring(0,src.indexOf('"'));
      return src;
    } else if(original.indexOf("watch?v=") >= 0){
      return original.replace("watch?v=","embed/")
    } else {
      return original;
    }
  }
  function clickVideo(clkevent){
    var src = $(clkevent).parent().find('.wp-video-src').val();
    src = getVideoURL(src);
    $(clkevent).parent().find('iframe').attr('src', src);
    $(clkevent).parent().find('.modal').modal('toggle');
    $('.modal').on('hidden.bs.modal', function () {
      $('iframe').attr('src', $('iframe').attr('src'));
    });
  }
  function clickImage(clkevent){
    var src = $(clkevent).parent().find('.wp-file-src').val();
    src = src.split("\\")[2]
    src = "/static/uploads/" + src;
    $(clkevent).parent().find('iframe').attr('src', src);
    $(clkevent).parent().find('.modal').modal('toggle');
    $('.modal').on('hidden.bs.modal', function () {
      $('iframe').attr('src', $('iframe').attr('src'));
    });
  }
  function clickFile(clkevent){
    console.log("HERE")
    var src = $(clkevent).parent().find('.wp-file-src').val();
    console.log(src);
    src = src.split("\\")[2]
    src = "/static/uploads/" + src;
    $(clkevent).parent().find('iframe').attr('src', src);
    $(clkevent).parent().find('.modal').modal('toggle');
    $('.modal').on('hidden.bs.modal', function () {
      $('iframe').attr('src', $('iframe').attr('src'));
    });
  }

  function addVideo(ctx){
    $(ctx).closest('.panel-body').find('.supplementary-target').append($('#wp-video-template').html());
  };
  function addAudio(ctx){
    $(ctx).closest('.panel-body').find('.supplementary-target').append($('#wp-audio-template').html());
  };
  function addText(ctx){
    $(ctx).closest('.panel-body').find('.supplementary-target').append($('#wp-text-template').html());
  };
  //Also used for other file upload
  function addImage(ctx){
    $(ctx).closest('.panel-body').find('.supplementary-target').append($('#wp-image-template').html());
  };
  function addOtherFile(ctx){
    $(ctx).closest('.panel-body').find('.supplementary-target').append($('#wp-file-template').html());
  };

  function uploadImageFile(f) {
      var form_data = new FormData(f);
      $.ajax({
          type: 'POST',
          url: '/upload',
          data: form_data,
          contentType: false,
          cache: false,
          processData: false,
          async: false,
          success: function(data) {
            console.log(f);
            var src = $(f).find('input').val();
            var src = src.split("\\")[2]
            src = "/static/uploads/" + src;
            $(f).closest('div.wp-image').find('img').first().attr("src", src);
          },
      });
  };
  function uploadFile(f) {
      var form_data = new FormData(f);
      console.log("HERE")
      $.ajax({
          type: 'POST',
          url: '/upload',
          data: form_data,
          contentType: false,
          cache: false,
          processData: false,
          async: false
      });
  };

  function changeTitle(element){
    console.log($(element).closest('div.wp-file'));
    $(element).closest('div.wp-file').find('h3').text($(element).val());
  }


  function textChange(element){
    var id_str = "#p_" + $(element).attr('id');
    $(element).parent().find(id_str).text($(element).val());
  }
  function textChangeBySibling(element){
    var id_str = "#p_" + $(element).attr('id');
    $(element).next('p').text($(element).val());
  }

  $(document).ready(function(){
    
    makeDroppable($('div.elementWell'));

    $("div.element").draggable({
      scroll: true,
      revert: true,
      distance: 25,
      stack: "div.element"
    });

    $('#preview').click(function(){
      $('.EDIT_ONLY').toggle();
      $('.TAKE_ONLY').toggle();
      if ($(this).val() == "Preview"){
        $(this).val("Edit");
      }
      else {
        $(this).val("Preview");
      }
    });

    $('#submit').click(function(){
      $('.EDIT_ONLY').remove();
      $('.PREVIEW_ONLY').remove();
      console.log($('#questionList').html());
      $.ajax({
        url: '{{ url_for("taskBuilder") }}',
        type: 'POST',
        contentType: 'text/plain',
        data: $('#questionList').html(),
        success:  function(data) {
          window.location.href='{{url_for("home")}}'
        },
        error: function(data){
          console.log(data);
        }
      });
    });

  });
</script>

{% endblock %}